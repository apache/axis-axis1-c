
<project name="buildTest" default="compileClient" basedir="..">

	<target name="buildClient" unless="runOnly">
		<antcall target="compileClient" inheritAll="true"/>
	</target>

	<!--
	  Need to set a language property for wsdl2ws
	  -->
	<target name="setLanguage">
		<condition property="generated.lang" value="c++">
			<equals arg1="${client.lang}" arg2="cpp"/>
		</condition>
		<condition property="generated.lang" value="c">
			<equals arg1="${client.lang}" arg2="c"/>
		</condition>
	</target>

	<!--
	  Use WSDL2Ws to generate stubs from WSDL files
	  -->
	<target name="generateStubs" if="test.wsdl" unless="test.dynamicCode" depends="setLanguage">
		<!-- Make directory in which all generated code shall be placed -->
		<mkdir dir="${dir.test.generated}/${client.lang}/${testName}"/>
		<!-- Setup classpath for WSDL2Ws -->
		<path id ="cp">
			<fileset dir="${dir.wsdl2ws}" includes="wsdl2ws.jar"/>
			<fileset dir="${dir.axisJARs}" includes="*.jar"/>
		</path>
		<!-- Run WSDL2Ws -->
		<java jar="${dir.wsdl2ws}/wsdl2ws.jar" fork="true">
			<classpath refid="cp"/>
			<arg value="${wsdl.test}"/>
			<arg value="-o${test.directory}"/>
			<arg value="-l${generated.lang}"/>
			<arg value="-sclient"/>
		</java>
	</target>

	<!--
	  Copy across test client, ready for compiling
	  -->
	<target name="getClient" depends="copyStubClient, copyDynamicClient"/>

	<target name="copyStubClient" depends="generateStubs, copyClientCode" unless="test.dynamicCode"/>

	<target name="copyClientCode" unless="test.dynamicCode">
		<copy file="${client.code}" todir="${test.directory}"/>
	</target>

	<target name="copyDynamicClient" if="test.dynamicCode">
		<copy todir="${test.directory}">
			<fileset dir="${dir.autotests}/dynamic/${test.dynamicCodeDirectory}">
				<include name="*.cpp"/>
				<include name="*.hpp"/>
			</fileset>
		</copy>
	</target>

	<!--
	  Compile test client
	  -->
	<target name="compileClient" depends="callCompileStaticClient, callCompileLinkedClient"/>

	<target name="callCompileStaticClient" unless="test.stubAsLibrary">
		<antcall target="compileStaticClient" inheritall="true"/>
	</target>
	<target name="callCompileLinkedClient" if="test.stubAsLibrary">
		<property name="libraryName" value="${testName}"/>
		<antcall target="compileLinkedClient" inheritall="true"/>
	</target>

	<target name="compileStaticClient" depends="getClient">
		<cc failonerror="false" incremental="false" outfile="${test.directory}/${testName}"
		 objdir="${test.directory}" exceptions="true"
		 outtype="executable" subsystem="console">
		 	<!-- Compilers -->
			<compiler refid="VisualC++"/>
			<compiler refid="Linuxgcc"/>
			<compiler refid="AIXxlc"/>
			<!-- Linkers -->
			<linker refid="VisualC++Linker"/>
			<linker refid="LinuxLinker"/>
			<linker refid="AIXExecutableLinker"/>
			<!-- Axis Client .lib file location, or UNIX shared object -->
			<libset dir="${dir.lib}" libs="${clientLibraryName}"/>
			<!-- Files to be compiled -->
			<includepath path="${dir.include}"/>
			<fileset dir="${test.directory}">
				<include name="*.${client.lang}"/>
			</fileset>
		</cc>
	</target>

	<target name="compileLinkedClient" depends="generateStubs, compileLibrary, copyClientCode">
		<basename file="${client.code}" property="client.source"/>
		<cc failonerror="false" incremental="false" outfile="${test.directory}/${testName}"
		 objdir="${test.directory}" exceptions="true"
		 outtype="executable" subsystem="console">
		 	<!-- Compilers -->
			<compiler refid="VisualC++"/>
			<compiler refid="Linuxgcc"/>
			<compiler refid="AIXxlc"/>
			<!-- Linkers -->
			<linker refid="VisualC++Linker"/>
			<linker refid="LinuxLinker"/>
			<linker refid="AIXExecutableLinker"/>
			<!-- Axis Client .lib file location, or UNIX shared object -->
			<libset dir="${dir.lib}" libs="${clientLibraryName}"/>
			<libset dir="${test.directory}" libs="${libraryName}"/>
			<!-- Files to be compiled -->
			<includepath path="${dir.include}"/>
			<fileset dir="${test.directory}">
				<include name="${client.source}"/>
			</fileset>
		</cc>
	</target>

</project>

